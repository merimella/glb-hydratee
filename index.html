<!DOCTYPE html>
<html>
<head>
    <title>GLB to PNG Exporter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.js"></script>
    <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>
    <script src="https://cdn.babylonjs.com/gizmos/babylon.gizmoManager.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="container">
            <div class="row mt-3">
                <div class="col-6">
                    <input type="file" id="fileInput" accept=".glb" class="form-control mb-3" style="width: 100%;" />
                </div>
            </div>
            <div class="container row">
                <div class="col-6">
                    <canvas id="renderCanvas"></canvas>
                </div>
                <div class="col-6">
                    <div class="axis-controls">
                        <div>
                            <label id="redX" for="rotX">X</label>
                            <input type="number" id="rotX" value="0" step="0.1" class="form-control" />
                        </div>
                        <div>
                            <label id="greenY" for="rotY">Y</label>
                            <input type="number" id="rotY" value="0" step="0.1" class="form-control" />
                        </div>
                        <div>
                            <label id="blueZ" for="rotZ">Z</label>
                            <input type="number" id="rotZ" value="0" step="0.1" class="form-control" />
                        </div>
                        <div>
                            <label for="zoom">+/-</label>
                            <input type="number" id="zoom" value="1.1" step="0.1" class="form-control" />
                        </div>
                    </div>
                    
                </div>
                <div class="container row">
                        <div class="col-6">
                            <div class="resol">
                            <div>
                                <input type="number" id="resolution" value="300" min="72" max="600" class="form-control mb-3" />
                               
                            </div>
                            <button onclick="captureScreenshot()" class="btn btn-success w-100">Capture Screenshot</button>
                        </div>
                    </div>
                </div>
            </div>
            
            
            
        
        </div>
    </div>
    <div class="question-icon" id="questionIcon">
        ?
    </div>
    <div class="modal-instructions" id="modalInstructions">
        <p>Inserisci le istruzioni qui.</p>
    </div>

    <script>
        let engine, scene, camera, model, transformNode, gizmoManager;

        const canvas = document.getElementById('renderCanvas');
        engine = new BABYLON.Engine(canvas, true);
        scene = new BABYLON.Scene(engine);

        scene.clearColor = new BABYLON.Color4(0, 0, 0, 0); // Set background to transparent

        camera = new BABYLON.ArcRotateCamera('camera', Math.PI / 2, Math.PI / 2, 1.1, BABYLON.Vector3.Zero(), scene);
        camera.attachControl(canvas, true);

        // Standard studio lights
        const light1 = new BABYLON.DirectionalLight("light1", new BABYLON.Vector3(0, -1, 1), scene);
        light1.position = new BABYLON.Vector3(0, 5, -5);
        const light2 = new BABYLON.DirectionalLight("light2", new BABYLON.Vector3(1, -1, 0), scene);
        light2.position = new BABYLON.Vector3(-5, 5, 0);
        const light3 = new BABYLON.DirectionalLight("light3", new BABYLON.Vector3(-1, -1, 0), scene);
        light3.position = new BABYLON.Vector3(5, 5, 0);
        const light4 = new BABYLON.HemisphericLight("light4", new BABYLON.Vector3(0, 1, 0), scene);
        light4.intensity = 0.5;

        engine.runRenderLoop(() => {
            if (scene) {
                scene.render();
            }
        });

        window.addEventListener('resize', () => {
            engine.resize();
        });

        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                console.log('File URL:', fileURL);
                if (model) {
                    model.meshes.forEach(mesh => mesh.dispose());
                }
                try {
                    const result = await BABYLON.SceneLoader.ImportMeshAsync('', fileURL, '', scene, null, '.glb');
                    model = result.meshes[0];
                    console.log('Model loaded:', model);

                    if (model) {
                        camera.target = model;
                        
                        // Initialize the transform node and attach the model to it
                        transformNode = new BABYLON.TransformNode("root");
                        model.parent = transformNode;

                        // Initialize gizmo manager and attach to transform node
                        gizmoManager = new BABYLON.GizmoManager(scene);
                        gizmoManager.rotationGizmoEnabled = true;
                        gizmoManager.usePointerToAttachGizmos = true;
                        gizmoManager.attachToMesh(transformNode);

                        // Update model rotation based on input
                        updateModelTransform();

                        // Update input fields based on gizmo movement
                        gizmoManager.gizmos.rotationGizmo.onDragEndObservable.add(() => {
                            document.getElementById('rotX').value = BABYLON.Tools.ToDegrees(transformNode.rotation.x).toFixed(1);
                            document.getElementById('rotY').value = BABYLON.Tools.ToDegrees(transformNode.rotation.y).toFixed(1);
                            document.getElementById('rotZ').value = BABYLON.Tools.ToDegrees(transformNode.rotation.z).toFixed(1);
                        });
                    }
                } catch (e) {
                    console.error('Error loading model:', e);
                }
            }
        });

        function updateModelTransform() {
            if (transformNode) {
                const rotX = BABYLON.Tools.ToRadians(parseFloat(document.getElementById('rotX').value));
                const rotY = BABYLON.Tools.ToRadians(parseFloat(document.getElementById('rotY').value));
                const rotZ = BABYLON.Tools.ToRadians(parseFloat(document.getElementById('rotZ').value));

                console.log(`Updating model rotation: rotX=${rotX}, rotY=${rotY}, rotZ=${rotZ}`);

                transformNode.rotation.x = rotX;
                transformNode.rotation.y = rotY;
                transformNode.rotation.z = rotZ;
            }
        }

        document.querySelectorAll('.axis-controls input[type=number]').forEach(input => {
            input.addEventListener('change', () => {
                console.log(`Input changed: ${input.id} = ${input.value}`);
                updateModelTransform();
            });
        });

        document.getElementById('zoom').addEventListener('input', () => {
            const zoomValue = parseFloat(document.getElementById('zoom').value);
            camera.radius = 2 / zoomValue;
        });

        camera.onViewMatrixChangedObservable.add(() => {
            document.getElementById('zoom').value = (2 / camera.radius).toFixed(1);
        });

        function captureScreenshot() {
            const dpi = parseInt(document.getElementById('resolution').value);
            const inches = 4; // For a 4x4 inch image
            const resolution = dpi * inches;
            engine.setSize(resolution, resolution);
            BABYLON.Tools.CreateScreenshotUsingRenderTarget(engine, camera, { width: resolution, height: resolution }, (data) => {
                const link = document.createElement('a');
                link.href = data;
                link.download = 'screenshot.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                engine.setSize(canvas.width, canvas.height); // Reset the engine size
            }, 'image/png', true);
        }

        document.getElementById('questionIcon').addEventListener('mouseenter', () => {
            document.getElementById('modalInstructions').classList.add('show');
        });

        document.getElementById('questionIcon').addEventListener('mouseleave', () => {
            document.getElementById('modalInstructions').classList.remove('show');
        });
    </script>
</body>
</html>
